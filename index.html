<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Serpent Siege v3.5</title>
  <style>
    :root{--bg:#0b0f0b;--ink:#f3f4f6;--panel:#12161a;--panel2:#1a2027;--accent:#ef4444;--grass1:#0e2b14;--grass2:#103418;--grass3:#13401d;--white:#ffffff;--gold:#f59e0b;--muted:#9ca3af;--good:#22c55e;--bad:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%;overflow:hidden}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;display:grid;place-items:center}
    .wrap{width:min(1140px,96vw)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:16px 0 10px}
    h1{margin:0;font-size:clamp(18px,2.4vw,28px)}
    .hud{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{background:var(--panel);border:1px solid #25303a;border-radius:12px;padding:6px 10px;display:flex;align-items:center;gap:8px;font-size:14px}
    .bar{position:relative;width:200px;height:10px;background:#1c2530;border:1px solid #283544;border-radius:999px;overflow:hidden}
    .bar>span{position:absolute;inset:0;width:100%;background:linear-gradient(90deg,#22c55e,#a3e635)}
    .btn{cursor:pointer;background:var(--panel);border:1px solid #2a3643;color:var(--ink);border-radius:10px;padding:6px 10px}
    .btn:hover{background:#1a222b}
    #gamePanel{background:var(--panel);border:1px solid #25303a;border-radius:16px;padding:12px;box-shadow:0 16px 60px rgba(0,0,0,.45)}
    canvas{image-rendering:pixelated;width:min(96vw,1140px);height:calc(min(96vw,1140px)*9/16);display:block;background:#0b0f0b;border-radius:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
    input[type="text"]{background:var(--panel2);color:var(--ink);border:1px solid #2a3643;border-radius:10px;padding:6px 10px}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{padding:6px 8px;border-bottom:1px solid #25303a;text-align:left}
    footer{opacity:.8;font-size:12px;margin-top:10px}
    kbd{background:#1c2530;border:1px solid #2a3643;padding:2px 6px;border-radius:6px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:11px}
    details{background:var(--panel);border:1px solid #25303a;border-radius:12px;padding:8px 12px;margin-top:8px}
    .pill{border-radius:999px;padding:2px 8px;font-size:12px}
    .pill.good{background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.4)}
    .pill.bad{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4)}
    .toast{position:fixed;bottom:12px;right:12px;background:#0f172a;color:#e2e8f0;border:1px solid #233045;border-radius:10px;padding:10px 12px;max-width:360px;box-shadow:0 8px 30px rgba(0,0,0,.4);display:none}
    #startOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:999}
    #startOverlay .panel{background:var(--panel);border:1px solid #25303a;border-radius:12px;padding:20px;display:flex;gap:10px;flex-direction:column;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üêÅ‚öîÔ∏è Serpent Siege ‚Äî Mouse vs. the Endless Snake</h1>
      <div class="hud">
        <div class="chip">Score: <span id="score">0</span></div>
        <div class="chip">Wave: <span id="wave">1</span></div>
        <div class="chip">Stamina <span class="bar"><span id="stamFill"></span></span></div>
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="restart" class="btn">Restart</button>
      </div>
    </header>
    <div id="gamePanel">
      <canvas id="game" width="1280" height="720"></canvas>
      <div class="row">
        <label>Name: <input id="playerName" type="text" maxlength="12" placeholder="Player"/></label>
        <button id="saveName" class="btn">Save Name</button>
        <button id="runTests" class="btn">Run self‚Äëtests (resets)</button>
        <span id="testSummary" class="pill" style="display:none"></span>
      </div>
      <div class="row" style="margin-top:2px;opacity:.85;font-size:13px">Move <kbd>WASD</kbd>/<kbd>Arrows</kbd> ¬∑ Sprint <kbd>Shift</kbd> ¬∑ Slash <kbd>Space</kbd> ¬∑ Pause <kbd>P</kbd></div>
      <div class="row">
        <table>
          <thead><tr><th>#</th><th>Name</th><th>Score</th><th>Date</th></tr></thead>
          <tbody id="board"></tbody>
        </table>
      </div>
      <details>
        <summary>Notes</summary>
        <ul style="margin:6px 0 0 18px;line-height:1.5">
          <li>This game does not use wallets. External wallet errors are ignored.</li>
          <li>Self‚Äëtests cover continuity, head step, body collision, stamina bounds, chasing, path fallback, wallet suppression, and growth.</li>
        </ul>
      </details>
    </div>
    <footer>Don‚Äôt touch the head. If the snake encloses you, you suffocate. Sever tail chunks for points; head lunges when close.</footer>
  </div>
  <div id="toast" class="toast"></div>
  <div id="startOverlay"><div class="panel"><label>Enter Name: <input id="startName" type="text" maxlength="12" placeholder="Player"/></label><button id="startBtn" class="btn">Play</button></div></div>
<script>
(()=>{
  const TILE=24,GRID_W=44,GRID_H=26,BORDER=1;const SNAKE_TICK=110,LUNGE_RANGE=3,LUNGE_SPEEDUP=.55;const SNAKE_GROW_ON_EAT=4,MICE_COUNT=3;const WALK_STEP_MS=175,SPRINT_STEP_MS=WALK_STEP_MS/2;const STAM_MAX=100,STAM_REGEN_PER_S=18,STAM_SPRINT_COST_PER_STEP=10,STAM_SLASH_COST=28;const SWORD_COOLDOWN=600,SLASH_TIME=250,SWORD_RANGE=2;const canvas=document.getElementById('game');const ctx=canvas.getContext('2d');const UI={score:document.getElementById('score'),wave:document.getElementById('wave'),stamFill:document.getElementById('stamFill'),pauseBtn:document.getElementById('pauseBtn'),restart:document.getElementById('restart'),name:document.getElementById('playerName'),saveName:document.getElementById('saveName'),board:document.getElementById('board'),runTests:document.getElementById('runTests'),testSummary:document.getElementById('testSummary'),toast:document.getElementById('toast'),startOverlay:document.getElementById('startOverlay'),startName:document.getElementById('startName'),startBtn:document.getElementById('startBtn')};
  UI.restart.style.display='none';
  const FIELD_W=GRID_W*TILE,FIELD_H=GRID_H*TILE,offsetX=Math.floor((canvas.width-FIELD_W)/2),offsetY=Math.floor((canvas.height-FIELD_H)/2);const DIRS={up:{x:0,y:-1},right:{x:1,y:0},down:{x:0,y:1},left:{x:-1,y:0}},DIR_LIST=[DIRS.up,DIRS.right,DIRS.down,DIRS.left];let rngSeed=Math.floor(Math.random()*1e9);const rand=()=>{let x=rngSeed^=rngSeed<<13;x^=x>>>17;x^=x<<5;rngSeed=x>>>0;return(rngSeed%1e6)/1e6};let keys=new Set();let lastMoveDir=DIRS.right;let score=0,wave=1,paused=false,gameOver=false,gameOverMsg='';const player={x:10,y:Math.floor(GRID_H*.5),facing:DIRS.right,name:'Player'};let playerAcc=0,slashAnimUntil=0,lastSlashAt=-9999,stamina=STAM_MAX;const snake={body:[],grow:0,speedMs:SNAKE_TICK,lungeUntil:0,strikeUntil:0};const foods=[];const within=(x,y)=>x>=BORDER&&y>=BORDER&&x<GRID_W-BORDER&&y<GRID_H-BORDER;const toKey=p=>p.x+","+p.y;const manhattan=(a,b)=>Math.abs(a.x-b.x)+Math.abs(a.y-b.y);const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));const occupiedBySnake=(x,y)=>snake.body.some(s=>s.x===x&&s.y===y);
  function initSnake(){snake.body.length=0;const cx=Math.floor(GRID_W*.65),cy=Math.floor(GRID_H*.5);for(let i=0;i<12;i++)snake.body.push({x:cx-i,y:cy});snake.grow=0;snake.speedMs=SNAKE_TICK;snake.lungeUntil=0;snake.strikeUntil=0}
  function emptyAt(x,y){if(!within(x,y))return false;if(player.x===x&&player.y===y)return false;if(occupiedBySnake(x,y))return false;for(const f of foods){if(f.x===x&&f.y===y)return false}return true}
  function spawnFoods(n=MICE_COUNT){foods.length=0;for(let i=0;i<n;i++)placeFood()}
  function placeFood(){for(let t=0;t<1e3;t++){const x=BORDER+Math.floor(rand()*(GRID_W-2*BORDER));const y=BORDER+Math.floor(rand()*(GRID_H-2*BORDER));if(emptyAt(x,y)){foods.push({x,y});return}}}
  function heuristic(a,b){return Math.abs(a.x-b.x)+Math.abs(a.y-b.y)}
  function findPath(start,goal){const open=new Map(),came=new Map(),g=new Map(),f=new Map();const startK=toKey(start);open.set(startK,start);g.set(startK,0);f.set(startK,heuristic(start,goal));const blocked=new Set();for(let i=0;i<snake.body.length-1;i++)blocked.add(toKey(snake.body[i]));let steps=0;while(open.size&&steps++<2000){let curK,cur,bestF=1/0;for(const [k,p]of open){const fv=f.get(k)||1/0;if(fv<bestF){bestF=fv;cur=p;curK=k}}if(!cur)break;if(cur.x===goal.x&&cur.y===goal.y){let ck=curK,cp=cur;while(came.has(ck)){const pk=came.get(ck);const[px,py]=pk.split(',').map(Number);const pp={x:px,y:py};if(pp.x===start.x&&pp.y===start.y)return cp;ck=pk;cp=pp}return cp}open.delete(curK);const neigh=DIR_LIST.map(d=>({x:cur.x+d.x,y:cur.y+d.y})).filter(p=>within(p.x,p.y)&&!blocked.has(toKey(p)));for(const nb of neigh){const nk=toKey(nb);const tentative=(g.get(curK)||1/0)+1;if(tentative<(g.get(nk)||1/0)){came.set(nk,curK);g.set(nk,tentative);f.set(nk,tentative+heuristic(nb,goal));open.set(nk,nb)}}}const dirs=DIR_LIST.slice().sort((a,b)=>heuristic({x:start.x+a.x,y:start.y+a.y},goal)-heuristic({x:start.x+b.x,y:start.y+b.y},goal));for(const d of dirs){const nx=start.x+d.x,ny=start.y+d.y;const k=toKey({x:nx,y:ny});if(within(nx,ny)&&!blocked.has(k))return{x:nx,y:ny}}return{x:start.x,y:start.y}}
  document.addEventListener('keydown',e=>{keys.add(e.code);if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code))e.preventDefault();if(e.code==='Space'){e.preventDefault();trySlash()}if(e.code==='KeyP'){togglePause()}});document.addEventListener('keyup',e=>{keys.delete(e.code)});UI.pauseBtn.addEventListener('click',togglePause);UI.restart.addEventListener('click',reset);UI.saveName.addEventListener('click',saveName);UI.runTests.addEventListener('click',()=>{paused=true;runSelfTests()});UI.startBtn.addEventListener('click',startGame);
  let lastTime=performance.now(),accSnake=0,pendingDeath=null;
  function update(dt){const now=performance.now();if(pendingDeath){if(now>=pendingDeath.at){endGame(pendingDeath.msg);pendingDeath=null}return}if(!(isSprinting()&&stamina>0)&&now-lastSlashAt>SLASH_TIME){stamina=clamp(stamina+(STAM_REGEN_PER_S*dt/1e3),0,STAM_MAX)}playerAcc+=dt;const stepMs=(isSprinting()&&stamina>0)?SPRINT_STEP_MS:WALK_STEP_MS;while(playerAcc>=stepMs){playerAcc-=stepMs;stepPlayer();if(isSprinting()&&stamina>0)stamina=clamp(stamina-STAM_SPRINT_COST_PER_STEP,0,STAM_MAX)}UI.stamFill.style.width=(stamina/STAM_MAX*100).toFixed(0)+'%';const head=snake.body[0];if(manhattan(head,player)<=LUNGE_RANGE){snake.lungeUntil=now+600}if(manhattan(head,player)<=1){killPlayer('The head snapped you up.');return}accSnake+=dt;const speed=(now<snake.lungeUntil)?Math.max(60,snake.speedMs*LUNGE_SPEEDUP):snake.speedMs;while(accSnake>=speed){accSnake-=speed;stepSnake();eatCheck();if(hitHead()){killPlayer('The head snapped you up.');return}if(checkEnclosed()){endGame('No escape. The serpent enclosed you.');return}}}
  function stepPlayer(){const dir=inputDir();if(!dir)return;player.facing=dir;lastMoveDir=dir;const nx=clamp(player.x+dir.x,BORDER,GRID_W-1-BORDER);const ny=clamp(player.y+dir.y,BORDER,GRID_H-1-BORDER);if(occupiedBySnake(nx,ny))return;player.x=nx;player.y=ny}
  function inputDir(){if(keys.has('ArrowUp')||keys.has('KeyW'))return DIRS.up;if(keys.has('ArrowDown')||keys.has('KeyS'))return DIRS.down;if(keys.has('ArrowLeft')||keys.has('KeyA'))return DIRS.left;if(keys.has('ArrowRight')||keys.has('KeyD'))return DIRS.right;return null}
  function isSprinting(){return keys.has('ShiftLeft')||keys.has('ShiftRight')}
  function trySlash(){const now=performance.now();if(now-lastSlashAt<SWORD_COOLDOWN)return;if(stamina<STAM_SLASH_COST)return;stamina=clamp(stamina-STAM_SLASH_COST,0,STAM_MAX);lastSlashAt=now;slashAnimUntil=now+SLASH_TIME;const dir=player.facing||lastMoveDir||DIRS.right;const hitTiles=[];for(let r=1;r<=SWORD_RANGE;r++)hitTiles.push({x:player.x+dir.x*r,y:player.y+dir.y*r});let hitIdx=-1;for(let i=1;i<snake.body.length;i++){const seg=snake.body[i];if(hitTiles.some(t=>t.x===seg.x&&t.y===seg.y)){hitIdx=i;break}}if(hitIdx>0){const cutLen=snake.body.length-hitIdx;snake.body.splice(hitIdx);const bonus=cutLen+Math.floor(cutLen*cutLen/10);addScore(bonus);slashBurst(hitTiles[0].x,hitTiles[0].y,cutLen)}}
  function stepSnake(){const head=snake.body[0];let target=foods[0],best=1/0;for(const f of foods){const d=Math.abs(f.x-head.x)+Math.abs(f.y-head.y);if(d<best){best=d;target=f}}if(!target){placeFood();target=foods[0]}const distPlayer=manhattan(head,player);if(snake.body.length>=18&&distPlayer<=6){const wraps=DIR_LIST.map(d=>({x:player.x+d.x,y:player.y+d.y}));for(const w of wraps){if(within(w.x,w.y)&&!occupiedBySnake(w.x,w.y)){target=w;break}}}let next=findPath(head,target);if(next.x===head.x&&next.y===head.y){const dirs=DIR_LIST.slice().sort((a,b)=>heuristic({x:head.x+a.x,y:head.y+a.y},target)-heuristic({x:head.x+b.x,y:head.y+b.y},target));for(const d of dirs){const nx=head.x+d.x,ny=head.y+d.y;if(within(nx,ny)&&!snake.body.slice(0,-1).some(s=>s.x===nx&&s.y===ny)){next={x:nx,y:ny};break}}}const dx=Math.sign(next.x-head.x),dy=Math.sign(next.y-head.y);const nx=head.x+dx,ny=head.y+dy;snake.body.unshift({x:nx,y:ny});if(snake.grow>0)snake.grow--;else snake.body.pop()}
  function eatCheck(){const head=snake.body[0];for(let i=0;i<foods.length;i++)if(foods[i].x===head.x&&foods[i].y===head.y){foods.splice(i,1);snake.grow+=SNAKE_GROW_ON_EAT;placeFood();break}}
  function hitHead(){const head=snake.body[0];return manhattan(head,player)<=1}
  function checkEnclosed(){const visited=new Set();const q=[{x:player.x,y:player.y}];const blocked=new Set(snake.body.map(s=>toKey(s)));while(q.length){const p=q.shift();const k=toKey(p);if(visited.has(k))continue;visited.add(k);if(p.x===BORDER||p.y===BORDER||p.x===GRID_W-1-BORDER||p.y===GRID_H-1-BORDER)return false;for(const d of DIR_LIST){const nx=p.x+d.x,ny=p.y+d.y;const nk=nx+","+ny;if(within(nx,ny)&&!blocked.has(nk)&&!visited.has(nk))q.push({x:nx,y:ny})}if(visited.size>GRID_W*GRID_H)break}return true}
  function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);drawFrame();drawGrass();foods.forEach(f=>drawFood(f.x,f.y));drawSnake();drawPlayer();drawSlash();if(gameOver)drawOverlay(gameOverMsg)}
  function drawFrame(){ctx.save();ctx.translate(offsetX,offsetY);ctx.strokeStyle='#22303a';ctx.lineWidth=2;roundRect(ctx,0,0,FIELD_W,FIELD_H,10);ctx.stroke();ctx.restore()}
  function drawGrass(){ctx.save();ctx.translate(offsetX,offsetY);for(let x=BORDER;x<GRID_W-BORDER;x++){for(let y=BORDER;y<GRID_H-BORDER;y++){const r=(x*73856093^y*19349663)&3;let c=r===0?getVar('--grass1'):r===1?getVar('--grass2'):getVar('--grass3');ctx.fillStyle=shade(c,(r-1)*6);ctx.fillRect(x*TILE,y*TILE,TILE,TILE);ctx.globalAlpha=.08;ctx.fillStyle='#ffffff';ctx.fillRect(x*TILE+6,y*TILE+5,1,1);ctx.fillRect(x*TILE+14,y*TILE+11,1,1);ctx.globalAlpha=1}}ctx.restore()}
  function drawFood(x,y){ctx.save();ctx.translate(offsetX+x*TILE,offsetY+y*TILE);pixelCircle(10,12,5,'#ffffff');pixelCircle(16,11,3,'#ffffff');ctx.fillStyle='#ffffff';ctx.fillRect(4,12,6,1);ctx.restore()}
  function drawSnake(){ctx.save();ctx.translate(offsetX,offsetY);const path=new Path2D();for(let i=0;i<snake.body.length;i++){const s=snake.body[i];const cx=s.x*TILE+TILE/2,cy=s.y*TILE+TILE/2;if(i===0)path.moveTo(cx,cy);else path.lineTo(cx,cy)}const bodyWidth=TILE*.74;ctx.strokeStyle='rgba(239,68,68,0.16)';ctx.lineWidth=bodyWidth*1.3;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke(path);const grad=ctx.createLinearGradient(0,0,FIELD_W,FIELD_H);grad.addColorStop(0,'#b91c1c');grad.addColorStop(1,'#ef4444');ctx.strokeStyle=grad;ctx.lineWidth=bodyWidth;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke(path);ctx.setLineDash([6,6]);ctx.lineDashOffset=(performance.now()/90)%12;ctx.strokeStyle='rgba(255,255,255,0.18)';ctx.lineWidth=bodyWidth*.89;ctx.stroke(path);ctx.setLineDash([]);const head=snake.body[0];const hx=head.x*TILE+TILE/2,hy=head.y*TILE+TILE/2;const striking=performance.now()<snake.strikeUntil;const hr=striking?bodyWidth*.75:bodyWidth*.55;pixelCircleAbs(hx,hy,hr,'#ef4444');pixelCircleAbs(hx,hy,TILE*.38,'#ef4444');pixelCircleAbs(hx-4,hy-3,3,'#0b0f0b');pixelCircleAbs(hx+4,hy-3,3,'#0b0f0b');const tail=snake.body[snake.body.length-1];const tx=tail.x*TILE+TILE/2,ty=tail.y*TILE+TILE/2;pixelCircleAbs(tx,ty,TILE*.28,'#991b1b');ctx.restore()}
  function drawPlayer(){const x=offsetX+player.x*TILE,y=offsetY+player.y*TILE;ctx.save();ctx.translate(x,y);ctx.globalAlpha=.35;pixelEllipse(12,18,10,4,'#000');ctx.globalAlpha=1;pixelCircle(12,12,9,'#d1d5db');pixelCircle(12,12,8,'#000000');pixelCircle(6,6,3,'#111111');pixelCircle(18,6,3,'#111111');ctx.fillStyle='#f3f4f6';ctx.fillRect(14,12,1,1);const d=player.facing||lastMoveDir||DIRS.right;ctx.save();if(d===DIRS.up)ctx.rotate(-Math.PI/2);else if(d===DIRS.down)ctx.rotate(Math.PI/2);else if(d===DIRS.left)ctx.scale(-1,1);ctx.fillStyle='#4b5563';ctx.fillRect(2,-2,6,3);ctx.fillStyle='#f59e0b';ctx.fillRect(8,-3,3,5);for(let i=0;i<28;i++){const yy=Math.round(Math.sin(i/18)*1.5);ctx.fillStyle='#d1d5db';ctx.fillRect(11+i,-2+yy,1,3)}ctx.globalAlpha=.7;ctx.fillStyle='#ffffff';for(let i=0;i<28;i+=3){const yy=Math.round(Math.sin(i/5)*1.5);ctx.fillRect(11+i,-1+yy,1,1)}ctx.globalAlpha=1;ctx.restore();ctx.restore()}
  function drawSlash(){const now=performance.now();if(now>slashAnimUntil)return;const t=1-(slashAnimUntil-now)/SLASH_TIME;const d=player.facing||lastMoveDir||DIRS.right;const angle=dirAngle(d);const cx=offsetX+player.x*TILE+TILE/2,cy=offsetY+player.y*TILE+TILE/2;ctx.save();ctx.translate(cx,cy);ctx.rotate(angle);ctx.globalCompositeOperation='lighter';ctx.globalAlpha=.25+.35*t;ctx.strokeStyle='#ffffff';ctx.lineWidth=TILE*.9*(1-t*.4);ctx.beginPath();ctx.arc(0,0,TILE*.9,-.7,.7);ctx.stroke();ctx.globalCompositeOperation='source-over';ctx.globalAlpha=1;ctx.restore()}
  const particles=[];function slashBurst(tx,ty,count){for(let i=0;i<Math.min(18,Math.ceil(count/2));i++){particles.push({x:tx*TILE+TILE/2+offsetX,y:ty*TILE+TILE/2+offsetY,vx:(rand()-.5)*3,vy:(rand()-.5)*3,life:500+rand()*300})}}
  function drawParticles(dt){for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.life-=dt;if(p.life<=0){particles.splice(i,1);continue}p.x+=p.vx;p.y+=p.vy;p.vy+=.02;const a=Math.max(0,Math.min(1,p.life/700));ctx.fillStyle=`rgba(255,255,255,${a})`;ctx.fillRect(p.x,p.y,2,2)}}
  function drawOverlay(msg){ctx.save();ctx.fillStyle='rgba(0,0,0,.55)';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#f3f4f6';ctx.textAlign='center';ctx.font='28px ui-rounded,system-ui,sans-serif';ctx.fillText('GAME OVER',canvas.width/2,canvas.height/2-8);ctx.font='16px ui-rounded,system-ui,sans-serif';ctx.fillStyle='#cbd5e1';wrapText(ctx,msg,canvas.width/2,canvas.height/2+18,560,20);ctx.restore()}
  const LS_KEY='serpent_siege_scores_v1';
  function saveName(){const n=UI.name.value.trim();if(n){player.name=n;localStorage.setItem('serpent_name',n)}renderBoard()}
  function loadName(){const n=localStorage.getItem('serpent_name');if(n){player.name=n;UI.name.value=n;UI.startName.value=n}}
  function saveScore(){const list=JSON.parse(localStorage.getItem(LS_KEY)||'[]');list.push({name:player.name||'Player',score,at:Date.now()});list.sort((a,b)=>b.score-a.score);const top=list.slice(0,20);localStorage.setItem(LS_KEY,JSON.stringify(top));renderBoard()}
  function renderBoard(){const list=JSON.parse(localStorage.getItem(LS_KEY)||'[]');UI.board.innerHTML=list.map((r,i)=>`<tr><td>${i+1}</td><td>${escapeHtml(r.name)}</td><td>${r.score}</td><td>${new Date(r.at).toLocaleDateString()}</td></tr>`).join('')}
  function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
  function togglePause(){paused=!paused;UI.pauseBtn.textContent=paused?'Resume':'Pause'}
  function addScore(n){score+=n;UI.score.textContent=score}
  function killPlayer(msg){const now=performance.now();snake.strikeUntil=now+250;pendingDeath={msg,at:now+250}}
  function endGame(msg){gameOver=true;gameOverMsg=msg;saveScore();UI.restart.style.display='inline-block'}
  function loop(t){const dt=t-lastTime;lastTime=t;if(!paused&&!gameOver){update(dt)}draw();drawParticles(dt);requestAnimationFrame(loop)}
  function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath()}
  function pixelCircle(cx,cy,r,color){ctx.fillStyle=color;for(let y=-r;y<=r;y++){for(let x=-r;x<=r;x++){if(x*x+y*y<=r*r)ctx.fillRect(cx+x,cy+y,1,1)}}}
  function pixelCircleAbs(ax,ay,r,color){ctx.save();ctx.beginPath();ctx.fillStyle=color;ctx.arc(ax,ay,r,0,Math.PI*2);ctx.fill();ctx.restore()}
  function pixelEllipse(cx,cy,rx,ry,color){ctx.fillStyle=color;for(let y=-ry;y<=ry;y++){for(let x=-rx;x<=rx;x++){if((x*x)/(rx*rx)+(y*y)/(ry*ry)<=1)ctx.fillRect(cx+x,cy+y,1,1)}}}
  function wrapText(ctx,text,x,y,maxWidth,lineHeight){const words=text.split(' ');let line='';let yy=y;for(let n=0;n<words.length;n++){const test=line+words[n]+' ';if(ctx.measureText(test).width>maxWidth&&n>0){ctx.fillText(line,x,yy);line=words[n]+' ';yy+=lineHeight}else line=test}ctx.fillText(line,x,yy)}
  function dirAngle(d){if(d===DIRS.right)return 0;if(d===DIRS.down)return Math.PI/2;if(d===DIRS.left)return Math.PI;return -Math.PI/2}
  function getVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim()}
  function shade(hex,amt){const c=parseInt(hex.replace('#',''),16);let r=(c>>16)&255,g=(c>>8)&255,b=c&255;r=clamp(r+amt,0,255);g=clamp(g+amt,0,255);b=clamp(b+amt,0,255);return`rgb(${r},${g},${b})`}
  function runSelfTests(){const prevName=player.name;const prevScores=localStorage.getItem(LS_KEY);reset();const results=[];results.push(test('snake contiguous',()=>{for(let i=1;i<snake.body.length;i++){if(manhattan(snake.body[i-1],snake.body[i])!==1)return false}return true}));results.push(test('head moves 1 tile per step',()=>{const before={...snake.body[0]};stepSnake();const after=snake.body[0];return manhattan(before,after)===1}));results.push(test('player blocked by body',()=>{const seg=snake.body[Math.floor(snake.body.length/2)];player.x=seg.x-1;player.y=seg.y;keys.clear();keys.add('ArrowRight');const px=player.x,py=player.y;stepPlayer();keys.delete('ArrowRight');return player.x===px&&player.y===py}));results.push(test('stamina clamp on slash',()=>{stamina=5;lastSlashAt=-9999;trySlash();return stamina>=0&&stamina<=STAM_MAX}));results.push(test('chase reaches food',()=>{foods.length=0;snake.body.length=0;for(let i=0;i<6;i++)snake.body.push({x:5-i,y:5});foods.push({x:20,y:5});let guard=0;while(!(snake.body[0].x===20&&snake.body[0].y===5)&&guard++<60){stepSnake()}return snake.body[0].x===20&&snake.body[0].y===5}));results.push(test('path fallback makes progress',()=>{foods.length=0;snake.body.length=0;snake.body.push({x:10,y:10},{x:9,y:10},{x:8,y:10});const start={...snake.body[0]};const goal={x:12,y:10};const nxt=findPath(start,goal);return !(nxt.x===start.x&&nxt.y===start.y)}));results.push(test('wallet error suppressed',()=>suppressExternal({message:'Failed to connect to MetaMask'})===true));results.push(test('growth after eating',()=>{reset();foods.length=0;const h=snake.body[0];foods.push({x:h.x+1,y:h.y});const len0=snake.body.length;stepSnake();eatCheck();for(let i=0;i<SNAKE_GROW_ON_EAT;i++){stepSnake()}return snake.body.length===len0+SNAKE_GROW_ON_EAT}));const ok=results.every(r=>r.pass);showTestSummary(ok,results);player.name=prevName;if(prevScores)localStorage.setItem(LS_KEY,prevScores);reset();paused=false}
  function test(name,fn){let pass=false,err='';try{pass=!!fn()}catch(e){pass=false;err=String(e.message||e)}return{name,pass,err}}
  function showTestSummary(ok,results){const pill=UI.testSummary;pill.style.display='inline-block';pill.textContent=ok?`Self‚Äëtests passed (${results.length}/${results.length})`:`Self‚Äëtests failed (${results.filter(r=>r.pass).length}/${results.length})`;pill.className='pill '+(ok?'good':'bad')}
  function reset(){score=0;wave=1;UI.score.textContent='0';UI.wave.textContent='1';gameOver=false;gameOverMsg='';pendingDeath=null;lastSlashAt=-9999;slashAnimUntil=0;stamina=STAM_MAX;playerAcc=0;player.x=10;player.y=Math.floor(GRID_H*.5);player.facing=DIRS.right;lastMoveDir=DIRS.right;paused=false;UI.restart.style.display='none';initSnake();spawnFoods(MICE_COUNT)}
  function startGame(){const n=UI.startName.value.trim();if(!n)return;player.name=n;UI.name.value=n;localStorage.setItem('serpent_name',n);UI.startOverlay.style.display='none';keys.clear();reset();lastTime=performance.now();requestAnimationFrame(t=>{lastTime=t;requestAnimationFrame(loop)})}
  loadName();renderBoard();
  function suppressExternal(e){const s=(e&&(e.message||e.reason||''))+'';return /metamask|ethereum/i.test(s)}
  window.addEventListener('error',e=>{if(suppressExternal(e)){e.preventDefault&&e.preventDefault();e.stopImmediatePropagation&&e.stopImmediatePropagation();return true}},true)
  window.addEventListener('unhandledrejection',e=>{if(suppressExternal(e)){e.preventDefault&&e.preventDefault();e.stopImmediatePropagation&&e.stopImmediatePropagation();return true}},true)
  window.onerror=function(msg){if(/metamask|ethereum/i.test(String(msg)))return true}
})();
</script>
</body>
</html>
